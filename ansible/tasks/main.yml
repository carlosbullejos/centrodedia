---
- name: Build & Push Docker images to ECR
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    aws_region:    "us-east-1"
    aws_account:   "799880597301"
    ecr_registry:  "{{ aws_account }}.dkr.ecr.{{ aws_region }}.amazonaws.com"
    templates_dir: "{{ playbook_dir }}/../templates"
    build_root:    "{{ playbook_dir }}/../build"

  tasks:
    # ─── Preparar directorio build ────────────────────────────────────────────
    - name: Clean build directory
      ansible.builtin.file:
        path: "{{ build_root }}"
        state: absent

    - name: Create build root directory
      ansible.builtin.file:
        path: "{{ build_root }}"
        state: directory
        mode: "0755"

    # ─── Contexto NGINX ───────────────────────────────────────────────────────
    - name: Create nginx build context
      ansible.builtin.file:
        path: "{{ build_root }}/nginx"
        state: directory
        mode: "0755"

    - name: Template NGINX Dockerfile
      ansible.builtin.template:
        src: "{{ templates_dir }}/Dockerfile_nginx.j2"
        dest: "{{ build_root }}/nginx/Dockerfile"
        mode: "0644"

    - name: Copy nginx.conf
      ansible.builtin.copy:
        src: "{{ templates_dir }}/nginx.conf"
        dest: "{{ build_root }}/nginx/nginx.conf"
        mode: "0644"

    - name: Copy server.conf
      ansible.builtin.copy:
        src: "{{ templates_dir }}/server.conf"
        dest: "{{ build_root }}/nginx/server.conf"
        mode: "0644"

    - name: Copy fullchain.pem
      ansible.builtin.copy:
        src: "{{ templates_dir }}/fullchain.pem"
        dest: "{{ build_root }}/nginx/fullchain.pem"
        mode: "0644"

    - name: Copy private.key
      ansible.builtin.copy:
        src: "{{ templates_dir }}/private.key"
        dest: "{{ build_root }}/nginx/private.key"
        mode: "0600"

    # ─── Contexto PHP‑FPM ────────────────────────────────────────────────────
    - name: Create php_fpm build context
      ansible.builtin.file:
        path: "{{ build_root }}/php_fpm"
        state: directory
        mode: "0755"

    - name: Template PHP‑FPM Dockerfile
      ansible.builtin.template:
        src: "{{ templates_dir }}/Dockerfile_php.j2"
        dest: "{{ build_root }}/php_fpm/Dockerfile"
        mode: "0644"

    # ─── Contexto MySQL ───────────────────────────────────────────────────────
    - name: Create mysql build context
      ansible.builtin.file:
        path: "{{ build_root }}/mysql"
        state: directory
        mode: "0755"

    - name: Template MySQL Dockerfile
      ansible.builtin.template:
        src: "{{ templates_dir }}/Dockerfile_mysql2.j2"
        dest: "{{ build_root }}/mysql/Dockerfile"
        mode: "0644"

    # ─── Contexto APACHE ──────────────────────────────────────────────────────
    - name: Create apache build context
      ansible.builtin.file:
        path: "{{ build_root }}/apache"
        state: directory
        mode: "0755"

    - name: Template Apache Dockerfile
      ansible.builtin.template:
        src: "{{ templates_dir }}/Dockerfile_apache.j2"
        dest: "{{ build_root }}/apache/Dockerfile"
        mode: "0644"

    # ─── Contexto FTP ─────────────────────────────────────────────────────────
    - name: Create ftp build context
      ansible.builtin.file:
        path: "{{ build_root }}/ftp"
        state: directory
        mode: "0755"

    - name: Template FTP Dockerfile
      ansible.builtin.template:
        src: "{{ templates_dir }}/Dockerfile_ftp.j2"
        dest: "{{ build_root }}/ftp/Dockerfile"
        mode: "0644"

    - name: Copy vsftpd.conf
      ansible.builtin.copy:
        src: "{{ templates_dir }}/vsftpd.conf"
        dest: "{{ build_root }}/ftp/vsftpd.conf"
        mode: "0644"

    - name: Copy vsftpd virtual users
      ansible.b
